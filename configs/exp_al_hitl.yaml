# /home/esakit25/work/tensaku/configs/exp_al_hitl.yaml

run:
  run_id: experiment_qid
  seed: 42
  # out_dir, data_dir は al.sh で環境変数 QID/OUT_DIR/DATA_DIR から上書きされる前提
  out_dir: /home/esakit25/work/tensaku/outputs/q-Y14_1-2_1_3
  data_dir: /home/esakit25/work/tensaku/data_sas/splits/q-Y14_1-2_1_3

data:
  input_all: /home/esakit25/work/tensaku/data_sas/all.jsonl
  qid: Y14_1-2_1_3
  files:
    labeled: labeled.jsonl
    dev: dev.jsonl
    test: test.jsonl
    pool: pool.jsonl
  text_key_primary: mecab
  text_key_fallback: text
  label_key: score
  id_key: id
  max_len: 128 # 高速化のため短縮

task:
  name: sas_total_score

split:
  enable: false
  ratio:
    test: 0.15
    dev: 0.15
    #labeled: 0.2
    #pool: 0.5
  freeze_dev_test: true
  seed: 42
  n_train: 50

model:
  name: cl-tohoku/bert-base-japanese-v3
  head: clf
  speed: full
  num_labels: 15
  ckpt: null # 自動解決のためnull

train:
  epochs: 20
  batch_size: 16  # 安定性重視
  lr_full: 2.0e-05
  lr_frozen: 0.0005
  early_stop_metric: "valid/loss"
  patience: 3

infer:
  ckpt: null
  trust: true
  trust_version: v2

calibration:
  enable: true
  T_min: 0.5
  T_max: 3.0
  step: 0.05
  n_bins: 15

confidence:
  estimators:
  - name: msp
  - name: entropy
  - name: energy
  - name: trust
    version: v2
    metric: cosine
    k_list: [5] # 高速化のため単一指定
    agg: median
    trim_q: 0.1
    normalize: zscore

viz:
  enable: true
  plots:
    - coverage_rmse
    - coverage_cse
    - reliability
    - aurc
    - learning_curve
  split_for_risk: "test"
  risk_coverage_conf_keys:
    - conf_msp
    - conf_trust
    - conf_entropy
    - conf_energy
  reliability_conf_keys:
    - conf_msp
  hist_multi_conf_keys:
    - conf_msp
    - conf_trust

gate:
  conf_key: trust
  eps_cse: 0.05
  eps_list: [0.02, 0.05]
  cse_abs_err: 2
  accept_policy: '>=tau'

hitl:
  cse_abs_err: 2
  eps_list: [0.02, 0.05]
  safety_margin: 0.01

# === 追加した AL セクション ===
al:
  rounds: 30          # デフォルトのラウンド数
  budget: 50          # 1ラウンドあたりの追加数
  #start_size: 50      # 初期ラベル付きデータ数
  seed: 42
  
  sampler:
    name: uncertainty       # uncertainty, random, hybrid, clustering
    uncertainty: trust      # msp, trust, entropy
    alpha: 3.0              # Hybrid用: 不確実性で絞る倍率 (Budget * alpha)
    k_center: 200           # Clustering用: センター数

logging:
  level: INFO